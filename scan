#!/usr/bin/env bash
set -euo pipefail

# Generated by RedCheck

# Crypto policy not LEGACY (CIS-1.6.1)
Use `update-crypto-policies --set DEFAULT` (or higher), avoid LEGACY.

# Disable root login over SSH (CIS-5.1.1)
Set 'PermitRootLogin no' in /etc/ssh/sshd_config and reload sshd.

# X11Forwarding disabled (CIS-5.1.6)
Set 'X11Forwarding no' in /etc/ssh/sshd_config and reload sshd.

# sudo has logfile (CIS-5.2.3)
Add 'Defaults logfile="/var/log/sudo.log"' in sudoers.

# SSH Banner configured (CIS-5.1.14)
Set 'Banner /etc/issue.net' (or similar) and reload sshd.

# IPv6 redirects disabled (all) (CIS-3.3.1)
Set net.ipv6.conf.all.accept_redirects=0 and persist in sysctl.conf.

# /dev/shm mounted with nodev,nosuid,noexec (CIS-1.1.2.2-devshm)
Ensure /dev/shm has nodev,nosuid,noexec (fstab or systemd mount).

# PAM pwquality present (CIS-5.3.1)
Ensure pam_pwquality.so is configured in system-auth/password-auth (via authselect).

# PAM pwhistory present (CIS-5.3.2)
Ensure pam_pwhistory.so is configured in system-auth/password-auth (via authselect).

# IPv6 accept_ra disabled (all) (CIS-3.3.3)
Set net.ipv6.conf.all.accept_ra=0 and persist.

# /tmp mounted with nodev,nosuid,noexec (CIS-1.1.2.2-tmp)
Ensure /tmp has nodev,nosuid,noexec (fstab or systemd tmp.mount).

# PASS_MAX_DAYS <= 365 (CIS-5.4.2)
Set PASS_MAX_DAYS 365 (or lower) in /etc/login.defs.

# Default INACTIVE <= 30 days (CIS-5.4.5)
Set `useradd -D -f 30` to enforce default inactive lock.

# PASS_MIN_DAYS >= 1 (CIS-5.4.3)
Set PASS_MIN_DAYS 1 (or higher) in /etc/login.defs.

# pwquality minlen >= 14 (CIS-5.3.1-args)
Set minlen=14 in pam_pwquality.

# pwquality retry <= 3 (CIS-5.3.1-retry)
In pam_pwquality.so line(s), set retry=3 or lower.

# IPv6 accept_ra disabled (default) (CIS-3.3.4)
Set net.ipv6.conf.default.accept_ra=0 and persist.

# pwquality minlen >= 14 (CIS-5.3.1-minlen)
In pam_pwquality.so line(s), set minlen=14 or higher.

# faillock unlock_time >= 900 (CIS-5.3.3-fail-unlock)
In pam_faillock.so line(s), set unlock_time=900 or higher.

# pwhistory remember >= 5 (CIS-5.3.2-remember)
In pam_pwhistory.so line(s), set remember=5 or higher.

# faillock deny <= 5 (CIS-5.3.3-fail-deny)
In pam_faillock.so line(s), set deny=5 or lower.

# IPv4 redirects disabled (all) (CIS-3.2.2)
Set net.ipv4.conf.all.accept_redirects=0 and persist.

# IPv4 redirects disabled (default) (CIS-3.2.3)
Set net.ipv4.conf.default.accept_redirects=0 and persist.

# IPv6 redirects disabled (default) (CIS-3.3.2)
Set net.ipv6.conf.default.accept_redirects=0 and persist.

# Local users comply with aging policy (CIS-5.4.users-aging)
For each flagged user, adjust with 'chage' (MAX<=365, MIN>=1, INACTIVE<=30).

# firewalld installed (CIS-4.1.1)
Install firewalld and enable the service.

# firewalld enabled and active (CIS-4.1.2)
systemctl enable --now firewalld

# Unexpected SUID/SGID files found (RC-1.1)
Review SUID/SGID files and remove from non-standard locations.
